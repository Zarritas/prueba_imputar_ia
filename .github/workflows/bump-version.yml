name: PR Version Bump & Merge

on:
  issue_comment:
    types: [created]

jobs:
  bump-and-merge:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/mergebot')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Enviar mensaje: iniciando proceso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="üõ†Ô∏è Iniciando proceso de merge solicitado con \`/mergebot\`‚Ä¶"

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr checkout ${{ github.event.issue.number }}

      - name: Rebase con main
        id: rebase
        continue-on-error: true
        run: |
          git fetch origin main
          git rebase origin/main || echo "REBASE_FAILED=true" >> $GITHUB_OUTPUT

      - name: Error rebase ‚Üí comentar en PR
        if: steps.rebase.outputs.REBASE_FAILED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚ùå No se pudo hacer **rebase con main**.  
            Por favor, resuelve los conflictos manualmente."
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Determine Bump Type
        id: bump-type
        run: |
          MESSAGE="${{ github.event.comment.body }}"
          if [[ "$MESSAGE" == *"/mergebot patch"* ]]; then
            echo "TYPE=patch" >> $GITHUB_OUTPUT
          elif [[ "$MESSAGE" == *"/mergebot minor"* ]]; then
            echo "TYPE=minor" >> $GITHUB_OUTPUT
          elif [[ "$MESSAGE" == *"/mergebot major"* ]] || [[ "$MESSAGE" == *"/mergebot mayor"* ]]; then
            echo "TYPE=major" >> $GITHUB_OUTPUT
          else
            echo "TYPE=none" >> $GITHUB_OUTPUT
          fi

      - name: Update Version
        id: update-version
        if: steps.bump-type.outputs.TYPE != 'none'
        env:
          BUMP_TYPE: ${{ steps.bump-type.outputs.TYPE }}
        run: |
          node -e "
            const fs = require('fs');
            const path = 'main/script.user.js';
            const content = fs.readFileSync(path, 'utf8');
            const regex = /\/\/ @version\s+(\d+\.\d+\.\d+)/;
            let [major, minor, patch] = content.match(regex)[1].split('.').map(Number);
            const type = process.env.BUMP_TYPE;
            if (type === 'major') { major++; minor = 0; patch = 0; }
            if (type === 'minor') { minor++; patch = 0; }
            if (type === 'patch') { patch++; }
            const newVersion = \`${major}.${minor}.${patch}\`;
            fs.writeFileSync(path, content.replace(regex, \`// @version      ${newVersion}\`));
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`NEW_VERSION=${newVersion}\n\`);
          "

      - name: Commit and Push
        if: steps.bump-type.outputs.TYPE != 'none'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add main/script.user.js
          git commit -m "chore: bump version to ${{ steps.update-version.outputs.NEW_VERSION }}"
          git push --force-with-lease

      - name: Merge PR
        id: merge
        if: steps.bump-type.outputs.TYPE != 'none'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.issue.number }} --merge --delete-branch || \
          echo "MERGE_FAILED=true" >> $GITHUB_OUTPUT

      - name: Error merge ‚Üí comentar en PR
        if: steps.merge.outputs.MERGE_FAILED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚ùå No se pudo **mergear** el PR.  
            Puede que existan conflictos o que GitHub lo haya bloqueado."

      - name: Merge correcto ‚Üí comentar √©xito
        if: steps.merge.outputs.MERGE_FAILED != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚úÖ **Merge completado con √©xito**.  
            Versi√≥n actualizada a \`${{ steps.update-version.outputs.NEW_VERSION }}\`."
